---
- name: Announce ansible role changed
  ansible.builtin.fail:
    msg: 'This role changed and now only support gitea. Please use the l3d.git.forgejo role for forgejo.'
  when: gitea_fork == 'forgejo'

- name: Perform optional versionscheck
  ansible.builtin.include_tasks:
    file: "versioncheck.yml"
  when: submodules_versioncheck | bool

- name: Gather installed packages for checks later on
  ansible.builtin.package_facts:
    manager: "auto"

- name: Gather variables for each operating system
  ansible.builtin.include_vars:
    file: "{{ lookup('ansible.builtin.first_found', gitea_variables) }}"

- name: Gather versioning information
  ansible.builtin.include_tasks:
    file: "set_gitea_version.yml"

- name: Backup gitea before update
  ansible.builtin.include_tasks:
    file: "backup.yml"
  when: gitea_backup_on_upgrade|bool

- name: Create gitea user and group
  ansible.builtin.include_tasks:
    file: "create_user.yml"

- name: "Install or update gitea"
  ansible.builtin.include_tasks:
    file: "install_gitea.yml"

- name: Create directories
  ansible.builtin.include_tasks:
    file: "directory.yml"

- name: Setup gitea systemd service
  ansible.builtin.include_tasks:
    file: "install_systemd.yml"
  when: ansible_service_mgr == "systemd"

- name: Generate JWT Secrets if undefined
  ansible.builtin.include_tasks:
    file: "jwt_secrets.yml"

- name: Generate gitea secrets if undefined
  ansible.builtin.include_tasks:
    file: "gitea_secrets.yml"

- name: Configure gitea
  ansible.builtin.include_tasks:
    file: "configure.yml"

- name: Deploy optional fail2ban rules
  ansible.builtin.include_tasks:
    file: "fail2ban.yml"
  when: gitea_fail2ban_enabled | bool

- name: Optionally customize gitea
  ansible.builtin.include_tasks:
    file: "customize_logo.yml"
  when: gitea_customize_logo | bool

- name: Optionally customize footer
  ansible.builtin.include_tasks:
    file: "customize_footer.yml"
  when: gitea_customize_footer | bool

- name: Optionally deploy public files
  ansible.builtin.include_tasks:
    file: "customize_public_files.yml"
  when: gitea_customize_files | bool or gitea_custom_themes is defined

- name: Optionally create local Users on git instance
  ansible.builtin.include_tasks:
    file: 'local_git_users.yml'
  when: gitea_users | length > 0
